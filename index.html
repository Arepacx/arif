<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>RFID Attendance Dashboard</title>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f4f4f4;
}
h1 { text-align: center; }
#clock {
    text-align: center;
    font-size: 20px;
    margin-bottom: 20px;
    font-weight: bold;
}
.btn {
    display: block;
    margin: 0 auto 10px;
    padding: 10px 20px;
    border: none;
    background: #007bff;
    color: white;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
}
#addBtn { background: #28a745; }
#resetBtn { background: #dc3545; }
#logoutBtn { background: #6c757d; }

table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    margin-top: 20px;
}
th, td {
    padding: 10px;
    text-align: center;
    border: 1px solid #ddd;
}
th { background: #007bff; color: white; }

.actionBtn {
    padding: 5px 10px;
    margin: 2px;
    cursor: pointer;
    border-radius: 4px;
    border: none;
    color: white;
}
.editBtn { background: #ffc107; color: black; }
.deleteBtn { background: #dc3545; }
</style>
</head>

<body>

<h1>RFID Student Management</h1>
<div id="clock"></div>

<button class="btn" id="loginBtn">ADMIN LOGIN</button>
<button class="btn" id="addBtn" style="display:none;">ADD STUDENT</button>
<button class="btn" id="resetBtn" style="display:none;">RESET ATTENDANCE</button>

<table>
<thead>
<tr>
    <th>UID</th>
    <th>Name</th>
    <th>Matrix</th>
    <th>Action</th>
</tr>
</thead>
<tbody id="studentTable"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, set, update, remove } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAbjjUJM8wzV23jeYEnGZ_qIBz2y_5IoDY",
  authDomain: "buzzer-5dbb9.firebaseapp.com",
  databaseURL: "https://buzzer-5dbb9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "buzzer-5dbb9"
};

const ADMIN_EMAIL = "4km4lnov@gmail.com";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth();

/* CLOCK */
setInterval(() => {
  const now = new Date();
  document.getElementById("clock").innerText =
    now.toLocaleDateString("en-GB") + " " +
    now.toLocaleTimeString("en-GB", { hour12: false });
}, 1000);

/* LOGIN */
loginBtn.onclick = () => {
  const email = prompt("Admin email:");
  const pass = prompt("Password:");
  signInWithEmailAndPassword(auth, email, pass)
    .catch(() => alert("Login failed"));
};

onAuthStateChanged(auth, user => {
  if (user && user.email === ADMIN_EMAIL) {
    addBtn.style.display = "block";
    resetBtn.style.display = "block";
    loginBtn.innerText = "LOGOUT";
    loginBtn.onclick = () => signOut(auth);
  } else {
    addBtn.style.display = "none";
    resetBtn.style.display = "none";
    loginBtn.innerText = "ADMIN LOGIN";
  }
});

/* LOAD STUDENTS */
const tableBody = document.getElementById("studentTable");

onValue(ref(db, "students"), snapshot => {
  tableBody.innerHTML = "";

  snapshot.forEach(child => {
    const uid = child.key;
    const name = child.child("name").val();
    const matrix = child.child("matrix").val();

    tableBody.innerHTML += `
      <tr>
        <td>${uid}</td>
        <td>${name}</td>
        <td>${matrix}</td>
        <td>
          <button class="actionBtn editBtn"
            onclick="editStudent('${uid}', '${name}', '${matrix}')">
            EDIT
          </button>
          <button class="actionBtn deleteBtn"
            onclick="deleteStudent('${uid}')">
            DELETE
          </button>
        </td>
      </tr>`;
  });
});

/* ADD STUDENT */
addBtn.onclick = async () => {
  const uid = prompt("RFID UID:");
  const name = prompt("Student Name:");
  const matrix = prompt("Matrix Number:");

  if (!uid || !name || !matrix) return;

  await set(ref(db, `students/${uid.toUpperCase()}`), {
    name: name.toUpperCase(),
    matrix: matrix.toUpperCase()
  });

  alert("Student added");
};

/* EDIT STUDENT */
window.editStudent = async (uid, oldName, oldMatrix) => {
  const name = prompt("Edit Name:", oldName);
  const matrix = prompt("Edit Matrix:", oldMatrix);

  if (!name || !matrix) return;

  await update(ref(db, `students/${uid}`), {
    name: name.toUpperCase(),
    matrix: matrix.toUpperCase()
  });

  alert("Student updated");
};

/* DELETE STUDENT */
window.deleteStudent = async (uid) => {
  if (!confirm(`Remove UID ${uid}?`)) return;

  await remove(ref(db, `students/${uid}`));
  await remove(ref(db, `attendance/${uid}`)); // optional cleanup

  alert("Student removed");
};

/* RESET ATTENDANCE STATUS ONLY */
resetBtn.onclick = async () => {
  if (!confirm("Reset attendance status only?")) return;

  onValue(ref(db, "attendance"), snapshot => {
    snapshot.forEach(child => {
      remove(ref(db, `attendance/${child.key}/logs`));
    });
  }, { onlyOnce: true });

  alert("Attendance reset");
};
</script>

</body>
</html>
