<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>RFID Attendance Dashboard</title>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f4f4f4;
}
h1 { text-align: center; }
#clock {
    text-align: center;
    font-size: 20px;
    margin-bottom: 15px;
    font-weight: bold;
}
.btn {
    display: block;
    margin: 0 auto 8px;
    padding: 10px 20px;
    border: none;
    color: white;
    border-radius: 6px;
    font-size: 15px;
    cursor: pointer;
}
#loginBtn { background:#007bff; }
#addBtn { background:#28a745; display:none; }
#resetBtn { background:#dc3545; display:none; }

table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    margin-top: 20px;
}
th, td {
    padding: 10px;
    text-align: center;
    border: 1px solid #ddd;
}
th { background: #007bff; color: white; }

.present { color: green; font-weight: bold; }
.absent { color: red; font-weight: bold; }

.actionBtn {
    padding: 5px 8px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    color: white;
}
.editBtn { background:#ffc107; color:black; }
.deleteBtn { background:#dc3545; }

#chartContainer {
    width: 360px;
    margin: 15px auto;
    background: white;
    padding: 15px;
    border-radius: 10px;
}
</style>
</head>

<body>

<h1>RFID Attendance Dashboard</h1>
<div id="clock"></div>

<button class="btn" id="loginBtn">ADMIN LOGIN</button>
<button class="btn" id="addBtn">ADD STUDENT</button>
<button class="btn" id="resetBtn">RESET ATTENDANCE</button>

<div id="chartContainer">
    <canvas id="attendanceChart"></canvas>
    <div id="percentText" style="text-align:center;font-weight:bold;"></div>
</div>

<table>
<thead>
<tr>
    <th id="uidHeader" style="display:none;">UID</th>
    <th>Matrix</th>
    <th>Name</th>
    <th>Date</th>
    <th>Time</th>
    <th>Status</th>
    <th id="actionHeader" style="display:none;">Action</th>
</tr>
</thead>
<tbody id="studentTable"></tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, set, update, remove, get } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

/* ================= CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyAbjjUJM8wzV23jeYEnGZ_qIBz2y_5IoDY",
  authDomain: "buzzer-5dbb9.firebaseapp.com",
  databaseURL: "https://buzzer-5dbb9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "buzzer-5dbb9"
};
const ADMIN_EMAIL = "4km4lnov@gmail.com";

/* ================= INIT ================= */
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth();

/* ================= CLOCK ================= */
setInterval(() => {
  const now = new Date();
  clock.innerText =
    now.toLocaleDateString("en-GB") + " " +
    now.toLocaleTimeString("en-GB", { hour12: false });
}, 1000);

/* ================= PIE CHART ================= */
const chart = new Chart(attendanceChart, {
  type: "pie",
  data: {
    labels: ["Present", "Absent"],
    datasets: [{
      data: [0, 0],
      backgroundColor: ["#28a745", "#dc3545"]
    }]
  }
});

/* ================= LOGIN ================= */
loginBtn.onclick = () => {
  const email = prompt("Admin email:");
  const pass = prompt("Password:");
  signInWithEmailAndPassword(auth, email, pass)
    .catch(() => alert("Login failed"));
};

onAuthStateChanged(auth, user => {
  const admin = user && user.email === ADMIN_EMAIL;

  addBtn.style.display = admin ? "block" : "none";
  resetBtn.style.display = admin ? "block" : "none";
  uidHeader.style.display = admin ? "table-cell" : "none";
  actionHeader.style.display = admin ? "table-cell" : "none";

  loginBtn.innerText = admin ? "LOGOUT" : "ADMIN LOGIN";
  loginBtn.onclick = admin ? () => signOut(auth) : loginBtn.onclick;
});

/* ================= ADD STUDENT ================= */
addBtn.onclick = async () => {
  const uid = prompt("RFID UID:");
  const name = prompt("Student Name:");
  const matrix = prompt("Matrix Number:");
  if (!uid || !name || !matrix) return;

  await set(ref(db, `students/${uid.toUpperCase()}`), {
    name: name.toUpperCase(),
    matrix: matrix.toUpperCase()
  });

  alert("Student added");
};

/* ================= DELETE CARD (FULL REMOVE) ================= */
window.deleteStudent = async (uid, matrix) => {
  if (!confirm("DELETE this card completely?")) return;

  await remove(ref(db, `students/${uid}`));
  await remove(ref(db, `attendance/${matrix}`));

  alert("Card removed. Admin must re-register.");
};

/* ================= RESET FIX (ALL ROWS) ================= */
resetBtn.onclick = async () => {
  if (!confirm("Reset attendance status for ALL students?")) return;

  const snap = await get(ref(db, "attendance"));
  const promises = [];

  snap.forEach(child => {
    promises.push(remove(ref(db, `attendance/${child.key}/logs`)));
  });

  await Promise.all(promises);
  alert("Attendance reset successfully");
};

/* ================= LOAD ATTENDANCE ================= */
onValue(ref(db, "attendance"), snapshot => {
  studentTable.innerHTML = "";
  let present = 0;
  let total = 0;

  snapshot.forEach(child => {
    total++;
    const matrix = child.key;
    const name = child.child("name").val() || "Unknown";
    const uid = child.child("uid").val() || "-";

    let date = "-", time = "-", isPresent = false;
    if (child.hasChild("logs")) {
      const logs = child.child("logs").val();
      date = logs.date || "-";
      time = logs.time || "-";
      isPresent = true;
    }
    if (isPresent) present++;

    studentTable.innerHTML += `
      <tr>
        <td style="display:${uidHeader.style.display}">${uid}</td>
        <td>${matrix}</td>
        <td>${name}</td>
        <td>${date}</td>
        <td>${time}</td>
        <td class="${isPresent ? "present" : "absent"}">
          ${isPresent ? "PRESENT" : "ABSENT"}
        </td>
        <td style="display:${actionHeader.style.display}">
          <button class="actionBtn deleteBtn"
            onclick="deleteStudent('${uid}','${matrix}')">DEL</button>
        </td>
      </tr>`;
  });

  chart.data.datasets[0].data = [present, total - present];
  chart.update();

  percentText.innerText =
    `Present: ${present} (${total ? ((present/total)*100).toFixed(1) : 0}%) | `
    + `Absent: ${total - present}`;
});
</script>

</body>
</html>
