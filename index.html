onValue(ref(db, "attendance"), snapshot => {
  studentTable.innerHTML = "";

  let present = 0;
  let total = 0;
  const rows = [];

  snapshot.forEach(child => {
    total++;

    const matrix = child.key;
    const name = child.child("name").val() || "Unknown";
    const uid = matrixToUID[matrix] || "-";

    let date = "-", time = "-", isPresent = false;

    if (child.hasChild("logs")) {
      const logs = child.child("logs").val();
      date = logs.date || "-";
      time = logs.time || "-";
      isPresent = true;
    }

    if (isPresent) present++;

    rows.push({
      uid,
      matrix,
      name,
      date,
      time,
      isPresent
    });
  });

  /* ðŸ”¥ SORT: ABSENT FIRST, PRESENT LAST */
  rows.sort((a, b) => a.isPresent - b.isPresent);

  /* RENDER TABLE */
  rows.forEach(r => {
    studentTable.innerHTML += `
      <tr>
        <td style="display:${uidHeader.style.display}">${r.uid}</td>
        <td>${r.matrix}</td>
        <td>${r.name}</td>
        <td>${r.date}</td>
        <td>${r.time}</td>
        <td class="${r.isPresent ? "present" : "absent"}">
          ${r.isPresent ? "PRESENT" : "ABSENT"}
        </td>
        <td style="display:${actionHeader.style.display}">
          <button class="actionBtn deleteBtn"
            onclick="deleteStudent('${r.uid}','${r.matrix}')">
            DEL
          </button>
        </td>
      </tr>`;
  });

  /* UPDATE PIE CHART */
  chart.data.datasets[0].data = [present, total - present];
  chart.update();

  percentText.innerText =
    `Present: ${present} (${total ? ((present/total)*100).toFixed(1) : 0}%) | `
    + `Absent: ${total - present}`;
});
